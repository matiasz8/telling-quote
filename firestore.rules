rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated and owns the resource
    function isOwner(uid) {
      return request.auth != null && request.auth.uid == uid;
    }

    // Helper function to validate reading data
    function isValidReading() {
      let reading = request.resource.data;
      return reading.keys().hasAll(['id', 'title', 'content', 'tags'])
        && reading.id is string
        && reading.title is string
        && reading.content is string
        && reading.tags is list;
    }

    // Helper function to validate settings data
    function isValidSettings() {
      let settings = request.resource.data;
      return settings.keys().hasAll(['fontSize', 'fontFamily', 'theme'])
        && settings.fontSize is string
        && settings.fontFamily is string
        && settings.theme is string;
    }

    // Helper function to validate accessibility settings
    function isValidAccessibility() {
      return true; // Less strict validation for accessibility
    }

    // User profile rules
    match /users/{uid}/profile/info {
      allow read: if isOwner(uid);
      allow write: if isOwner(uid);
    }

    // Readings rules
    match /users/{uid}/readings/{readingId} {
      allow read: if isOwner(uid);
      allow create, update: if isOwner(uid) && isValidReading();
      allow delete: if isOwner(uid);
    }

    // Settings rules
    match /users/{uid}/settings/preferences {
      allow read: if isOwner(uid);
      allow write: if isOwner(uid) && isValidSettings();
    }

    // Accessibility settings rules
    match /users/{uid}/settings/accessibility {
      allow read: if isOwner(uid);
      allow write: if isOwner(uid) && isValidAccessibility();
    }

    // Deny all other reads/writes by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
